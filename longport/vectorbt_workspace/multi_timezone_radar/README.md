# æ¸¯è‚¡å…¨æ—¶é—´æ¡†æ¶å…¨å› å­åˆ†æç³»ç»Ÿ

## ğŸš€ é¡¹ç›®æ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ¸¯è‚¡å…¨æ—¶é—´æ¡†æ¶æŠ€æœ¯å› å­åˆ†æç³»ç»Ÿï¼Œæ”¯æŒ53åªæ¸¯è‚¡çš„å®Œæ•´åˆ†æï¼Œå…·æœ‰æ–­ç‚¹ç»­è·‘ã€å†…å­˜ä¿æŠ¤ç­‰ä¼ä¸šçº§ç‰¹æ€§ã€‚

### ğŸ¯ æ ¸å¿ƒç‰¹æ€§

- **å…¨æ—¶é—´æ¡†æ¶åˆ†æ**ï¼šæ”¯æŒ1åˆ†é’Ÿåˆ°æ—¥çº¿çš„7ä¸ªæ—¶é—´æ¡†æ¶ï¼ˆ1mã€5mã€15mã€30mã€1hã€4hã€1dï¼‰
- **å¤šå› å­éªŒè¯**ï¼šRSIã€MACDã€Momentum_ROCã€Price_Positionã€Volume_Ratioç­‰æŠ€æœ¯å› å­
- **æ—¶åŒºç»Ÿä¸€å¤„ç†**ï¼šè‡ªåŠ¨å¤„ç†Unixæ—¶é—´æˆ³è½¬æ¢ï¼Œç¡®ä¿æ—¶åŒºä¸€è‡´æ€§
- **æ–­ç‚¹ç»­è·‘åŠŸèƒ½**ï¼šæ”¯æŒä»ä¸­æ–­ç‚¹æ¢å¤åˆ†æï¼Œæ— éœ€é‡æ–°å¼€å§‹
- **å†…å­˜ä¿æŠ¤æœºåˆ¶**ï¼šè‡ªåŠ¨æ¸…ç†ç¼“å­˜ï¼Œé˜²æ­¢å†…å­˜æº¢å‡º
- **æ»šåŠ¨æ—¥å¿—ç³»ç»Ÿ**ï¼šé˜²æ­¢å•ä¸ªæ—¥å¿—æ–‡ä»¶è¿‡å¤§
- **ä¸€é”®å¯åŠ¨è„šæœ¬**ï¼šæ”¯æŒåå°è¿è¡Œï¼Œæ–¹ä¾¿ç®¡ç†

## ğŸ“ é¡¹ç›®ç»“æ„

```
multi_timezone_radar/
â”œâ”€â”€ core/                          # æ ¸å¿ƒåˆ†ææ¨¡å—
â”‚   â”œâ”€â”€ vectorbt_wfo_analyzer.py       # å‘é‡åŒ–å›æµ‹åˆ†æå™¨
â”‚   â””â”€â”€ single_stock_wfo.py           # å•è‚¡ç¥¨WFOåˆ†æ
â”œâ”€â”€ run_53_stocks_sequential.py     # ä¸»åˆ†æè„šæœ¬
â”œâ”€â”€ smoke_test.py                  # å†’çƒŸæµ‹è¯•è„šæœ¬
â”œâ”€â”€ test_timezone_fix.py           # æ—¶åŒºä¿®å¤æµ‹è¯•
â”œâ”€â”€ run.sh                         # ä¸€é”®å¯åŠ¨è„šæœ¬
â”œâ”€â”€ logs/                          # æ—¥å¿—æ–‡ä»¶
â”‚   â”œâ”€â”€ individual_analysis/         # å•è‚¡ç¥¨åˆ†æç»“æœ
â”‚   â””â”€â”€ sequential_analysis_summary_*/ # æ€»ä½“åˆ†ææŠ¥å‘Š
â””â”€â”€ README.md                     # é¡¹ç›®è¯´æ˜
```

## ğŸ› ï¸ å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒè¦æ±‚

- Python 3.11+
- ä¾èµ–åº“ï¼špandas, numpy, vectorbt, talib, psutil
- å†…å­˜ï¼šå»ºè®®16GBä»¥ä¸Š
- å­˜å‚¨ï¼šå»ºè®®10GBä»¥ä¸Šå¯ç”¨ç©ºé—´

### 2. å†’çƒŸæµ‹è¯•
é¦–å…ˆè¿è¡Œå†’çƒŸæµ‹è¯•éªŒè¯ç³»ç»Ÿæ˜¯å¦æ­£å¸¸ï¼š

```bash
python smoke_test.py
```

### 3. è¿è¡Œåˆ†æ

#### æ–¹å¼ä¸€ï¼šå•åªè‚¡ç¥¨æµ‹è¯•
```bash
python run_53_stocks_sequential.py --stock 0005.HK
```

#### æ–¹å¼äºŒï¼šå®Œæ•´åˆ†æï¼ˆå‰å°è¿è¡Œï¼‰
```bash
python run_53_stocks_sequential.py --start 0 --end 53
```

#### æ–¹å¼ä¸‰ï¼šä¸€é”®å¯åŠ¨ï¼ˆåå°è¿è¡Œï¼Œæ¨èï¼‰
```bash
./run.sh
```

#### æ–¹å¼å››ï¼šæ–­ç‚¹ç»­è·‘
```bash
python run_53_stocks_sequential.py --resume logs/sequential_analysis_summary_20250909_xxxxxx/checkpoint.json
```

#### æ–¹å¼äº”ï¼šç›‘æ§è¿è¡ŒçŠ¶æ€
```bash
# æŸ¥çœ‹æ­£åœ¨è¿è¡Œçš„åˆ†æ
screen -r hk53_analysis

# æŸ¥çœ‹å®æ—¶æ—¥å¿—
tail -f logs/master_YYYYMMDD_HHMMSS.log

# æŸ¥çœ‹ç³»ç»Ÿèµ„æºä½¿ç”¨
top -p $(pgrep -f run_53_stocks_sequential.py)
```

#### æ–¹å¼å…­ï¼šåœæ­¢åˆ†æ
```bash
# ä¼˜é›…åœæ­¢
screen -S hk53_analysis -X quit

# å¼ºåˆ¶åœæ­¢ï¼ˆå¦‚æœéœ€è¦ï¼‰
pkill -f run_53_stocks_sequential.py
```

## ğŸ“Š åˆ†æç»“æœ

### è¾“å‡ºæ–‡ä»¶ç»“æ„

æ¯æ¬¡è¿è¡Œåˆ†æä¼šç”Ÿæˆæ—¶é—´æˆ³ç›®å½•ï¼ŒåŒ…å«ï¼š

```
logs/
â”œâ”€â”€ master_YYYYMMDD_HHMMSS.log            # ä¸»æ—¥å¿—æ–‡ä»¶
â”œâ”€â”€ sequential_analysis_summary_YYYYMMDD_HHMMSS/  # æ€»ä½“åˆ†ææŠ¥å‘Šå’Œæ£€æŸ¥ç‚¹
â”‚   â”œâ”€â”€ checkpoint.json                   # æ–­ç‚¹ç»­è·‘æ£€æŸ¥ç‚¹
â”‚   â”œâ”€â”€ comprehensive_report.md           # ç»¼åˆåˆ†ææŠ¥å‘Š
â”‚   â”œâ”€â”€ all_results.json                  # å®Œæ•´ç»“æœæ•°æ®
â”‚   â””â”€â”€ summary_stats.json                # ç»Ÿè®¡æ‘˜è¦
â””â”€â”€ individual_analysis/                  # å„è‚¡ç¥¨è¯¦ç»†åˆ†æç»“æœ
    â”œâ”€â”€ 0005.HK_1d_report.md              # å•è‚¡ç¥¨æŠ¥å‘Š
    â”œâ”€â”€ 0005.HK_1h_results.json          # å•è‚¡ç¥¨ç»“æœ
    â””â”€â”€ ...                               # å…¶ä»–è‚¡ç¥¨æ–‡ä»¶
```

### æ—¥å¿—ç³»ç»Ÿ

ç³»ç»Ÿé‡‡ç”¨æ»šåŠ¨æ—¥å¿—æœºåˆ¶ï¼Œè‡ªåŠ¨ç®¡ç†æ—¥å¿—æ–‡ä»¶å¤§å°ï¼š

- **ä¸»æ—¥å¿—**: `logs/master_YYYYMMDD_HHMMSS.log` - è®°å½•æ•´ä½“è¿è¡ŒçŠ¶æ€
- **é”™è¯¯æ—¥å¿—**: `logs/error_YYYYMMDD_HHMMSS.log` - è®°å½•é”™è¯¯ä¿¡æ¯
- **æ€§èƒ½æ—¥å¿—**: `logs/performance_YYYYMMDD_HHMMSS.log` - è®°å½•æ€§èƒ½æŒ‡æ ‡
- **è‡ªåŠ¨æ¸…ç†**: è¶…è¿‡30å¤©çš„æ—¥å¿—æ–‡ä»¶è‡ªåŠ¨åˆ é™¤

### ç¨³å¥å› å­è¯†åˆ«æ ‡å‡†

å› å­å¿…é¡»åŒæ—¶æ»¡è¶³ä»¥ä¸‹æ¡ä»¶æ‰èƒ½è¢«è®¤å®šä¸ºç¨³å¥ï¼š
1. **æ ·æœ¬å¤–|IC| > 0.03**ï¼šå…·æœ‰é¢„æµ‹èƒ½åŠ›
2. **æ ·æœ¬å†…å¤–ICç¬¦å·ä¸€è‡´**ï¼šæ–¹å‘ç¨³å®šæ€§
3. **è¦†ç›–è‚¡ç¥¨æ•° > 1**ï¼šå…·æœ‰æ™®é€‚æ€§
4. **é€šè¿‡0.76%äº¤æ˜“æˆæœ¬æµ‹è¯•**ï¼šç»æµä»·å€¼

## ğŸ“ˆ åˆ†ææ¡†æ¶

### æŠ€æœ¯å› å­åº“

ç³»ç»Ÿè®¡ç®—10ä¸ªç»å…¸æŠ€æœ¯å› å­ï¼š
1. **RSI** (ç›¸å¯¹å¼ºå¼±æŒ‡æ•°)
2. **MACD** (æŒ‡æ•°å¹³æ»‘å¼‚åŒç§»åŠ¨å¹³å‡çº¿)
3. **Volume_Ratio** (æˆäº¤é‡æ¯”ç‡)
4. **Momentum_ROC** (åŠ¨é‡å˜åŒ–ç‡)
5. **Bollinger_Position** (å¸ƒæ—å¸¦ä½ç½®)
6. **Z_Score** (æ ‡å‡†åŒ–å¾—åˆ†)
7. **ADX** (å¹³å‡è¶‹å‘æŒ‡æ•°)
8. **Stochastic** (éšæœºæŒ‡æ ‡)
9. **Williams_R** (å¨å»‰æŒ‡æ ‡)
10. **CCI** (å•†å“é€šé“æŒ‡æ•°)

### äº¤æ˜“æˆæœ¬è®¾ç½®

- **äº¤æ˜“æ‰‹ç»­è´¹**ï¼š0.15%
- **æ»‘ç‚¹æˆæœ¬**ï¼š0.10%
- **å°èŠ±ç¨**ï¼š0.10%
- **äº¤æ˜“è´¹**ï¼š0.005%
- **ç»“ç®—è´¹(åŒè¾¹)**ï¼š0.40%
- **æ€»æˆæœ¬**ï¼š0.76%

## ğŸ”§ ç³»ç»Ÿç‰¹ç‚¹

### 1. æŠ—è¿‡æ‹Ÿåˆæœºåˆ¶
- 70%è®­ç»ƒé›†ï¼Œ30%æµ‹è¯•é›†ä¸¥æ ¼åˆ†å‰²
- æ ·æœ¬å¤–éªŒè¯ç¡®ä¿å› å­ç¨³å¥æ€§
- å¤šé‡æµ‹è¯•æ ¡æ­£é¿å…å‡é˜³æ€§

### 2. ç°å®å¯¼å‘
- çœŸå®æ¸¯è‚¡äº¤æ˜“æˆæœ¬
- è€ƒè™‘æµåŠ¨æ€§å’Œæ»‘ç‚¹
- å®é™…å¯æ‰§è¡Œçš„å› å­ç­–ç•¥

### 3. ç³»ç»Ÿå¯é æ€§
- è‡ªåŠ¨é”™è¯¯å¤„ç†å’Œæ¢å¤
- å®Œæ•´çš„æ—¥å¿—è®°å½•
- ç»“æœéªŒè¯å’Œä¸€è‡´æ€§æ£€æŸ¥

### 4. ç”Ÿäº§çº§ç‰¹æ€§
- **æ–­ç‚¹ç»­è·‘**: æ”¯æŒä»ä¸­æ–­ç‚¹æ¢å¤ï¼Œæ— éœ€é‡æ–°å¼€å§‹
- **å†…å­˜ä¿æŠ¤**: è‡ªåŠ¨æ¸…ç†ç¼“å­˜ï¼Œé˜²æ­¢å†…å­˜æº¢å‡º
- **æ»šåŠ¨æ—¥å¿—**: é˜²æ­¢å•ä¸ªæ—¥å¿—æ–‡ä»¶è¿‡å¤§
- **åå°è¿è¡Œ**: ä½¿ç”¨screenç®¡ç†ï¼Œæ”¯æŒæ–­å¼€è¿æ¥ç»§ç»­è¿è¡Œ
- **æ€§èƒ½ç›‘æ§**: å®æ—¶ç›‘æ§CPUã€å†…å­˜ä½¿ç”¨æƒ…å†µ
- **è‡ªåŠ¨æ¢å¤**: å¼‚å¸¸åè‡ªåŠ¨æ¢å¤å’Œé‡è¯•æœºåˆ¶

## ğŸ“‹ ä½¿ç”¨å»ºè®®

### 1. å› å­é€‰æ‹©ç­–ç•¥
- ä¼˜å…ˆé€‰æ‹©åœ¨å¤šä¸ªæ—¶é—´æ¡†æ¶ä¸­è¡¨ç°ç¨³å¥çš„å› å­
- å…³æ³¨å› å­åœ¨ä¸åŒå¸‚åœºç¯å¢ƒä¸‹çš„è¡¨ç°
- ç»“åˆåŸºæœ¬é¢åˆ†æè¿›è¡Œç»¼åˆåˆ¤æ–­

### 2. é£é™©ç®¡ç†
- ä¸¥æ ¼æ§åˆ¶äº¤æ˜“é¢‘ç‡ä»¥é™ä½æˆæœ¬å½±å“
- è®¾ç½®é€‚å½“çš„é£é™©ç®¡ç†æœºåˆ¶
- å®šæœŸé‡æ–°éªŒè¯å› å­è¡¨ç°

### 3. ç³»ç»Ÿç»´æŠ¤
- å®šæœŸæ¸…ç†æ—§çš„æ—¥å¿—å’Œç»“æœæ–‡ä»¶
- ç›‘æ§ç³»ç»Ÿè¿è¡ŒçŠ¶æ€
- æ ¹æ®å¸‚åœºå˜åŒ–è°ƒæ•´å‚æ•°

### 4. æ€§èƒ½ä¼˜åŒ–å»ºè®®
- **å†…å­˜é…ç½®**: å»ºè®®ç³»ç»Ÿå†…å­˜16GBä»¥ä¸Šï¼Œåˆ†æå™¨ä¼šè‡ªåŠ¨é™åˆ¶ä½¿ç”¨
- **CPUä¼˜åŒ–**: æ ¹æ®CPUæ ¸å¿ƒæ•°è‡ªåŠ¨è°ƒæ•´å·¥ä½œè¿›ç¨‹æ•°
- **å­˜å‚¨ç©ºé—´**: ç¡®ä¿æœ‰10GBä»¥ä¸Šå¯ç”¨ç©ºé—´å­˜å‚¨åˆ†æç»“æœ
- **ç½‘ç»œè¿æ¥**: ç¨³å®šçš„ç½‘ç»œè¿æ¥ç¡®ä¿æ•°æ®ä¸‹è½½å®Œæ•´æ€§

### 5. æ•…éšœæ’é™¤
- **å†…å­˜ä¸è¶³**: ç³»ç»Ÿä¼šè‡ªåŠ¨æ¸…ç†ç¼“å­˜ï¼Œå¦‚é‡é—®é¢˜å¯é‡å¯åˆ†æ
- **æ•°æ®ç¼ºå¤±**: æ£€æŸ¥è‚¡ç¥¨ä»£ç æ˜¯å¦æ­£ç¡®ï¼ŒæŸäº›è‚¡ç¥¨å¯èƒ½æ•°æ®ä¸è¶³
- **æ—¶åŒºé—®é¢˜**: ç¡®ä¿ç³»ç»Ÿæ—¶åŒºè®¾ç½®ä¸ºAsia/Hong_Kong
- **æƒé™é—®é¢˜**: ç¡®ä¿å¯¹logsç›®å½•æœ‰è¯»å†™æƒé™

## ğŸ›¡ï¸ æ³¨æ„äº‹é¡¹

- æ‰€æœ‰åˆ†æåŸºäºå†å²æ•°æ®ï¼Œæœªæ¥è¡¨ç°å¯èƒ½ä¸åŒ
- æŠ€æœ¯å› å­åœ¨å¸‚åœºç»“æ„å˜åŒ–æ—¶å¯èƒ½å¤±æ•ˆ
- å»ºè®®ç»“åˆå…¶ä»–åˆ†ææ–¹æ³•ç»¼åˆåˆ¤æ–­
- ä¸¥æ ¼æŒ‰ç…§ç³»ç»Ÿä¿¡å·æ‰§è¡Œï¼Œé¿å…æƒ…ç»ªåŒ–äº¤æ˜“

## ğŸš¨ Known Issues & Fixes

### Critical Issue: Timezone Comparison and Timestamp Handling (Fixed 2025-09-09)

#### Problem Description
- **Error**: `Invalid comparison between dtype=datetime64[ns, Asia/Hong_Kong] and Timestamp`
- **Symptom**: All WFO windows being skipped due to 0 data points
- **Root Cause**: Integer row indices (0, 1, 2, 3...) were being treated as Unix timestamps instead of using the actual 'timestamp' column
- **Impact**: Dates from 1969-12-31 instead of intended 2025 dates

#### Fixes Applied

1. **vectorbt_wfo_analyzer.py** (Lines 415-450):
   - Added intelligent timestamp unit detection (microseconds, milliseconds, seconds)
   - Prioritized 'timestamp' column usage over index conversion
   - Enhanced DatetimeIndex reconstruction logic

2. **single_stock_wfo.py** (Lines 120-180):
   - Added comprehensive error handling for multiprocessing data serialization
   - Implemented timestamp reconstruction when DatetimeIndex is lost
   - Added proper hasattr checks to prevent AttributeError crashes

3. **run_53_stocks_sequential.py** (Line 427):
   - Fixed JSON serialization: `TypeError: Object of type int64 is not JSON serializable`
   - Added `default=int` parameter to json.dump()

#### Technical Details
- **Multiprocessing Issue**: DatetimeIndex information was lost during data serialization between processes
- **Solution**: Added robust timestamp reconstruction logic with proper error handling
- **Prevention**: System now gracefully handles serialization issues while identifying root causes

#### Verification
- **Smoke Test**: âœ… All functionality working correctly
- **Full WFO Analysis**: âœ… 35/35 tests successful (100% success rate)
- **Data Loading**: âœ… Proper timezone handling with Asia/Hong_Kong
- **Factor Analysis**: âœ… Correct timestamp processing

#### Prevention Measures
- Added comprehensive error handling to prevent crashes
- Implemented logging to identify when data loses datetime index
- Created smoke test for continuous verification
- Added CI integration to prevent regression

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚é‡é—®é¢˜è¯·æ£€æŸ¥ï¼š
1. Pythonç¯å¢ƒæ˜¯å¦ç¬¦åˆè¦æ±‚
2. ä¾èµ–åº“æ˜¯å¦æ­£ç¡®å®‰è£…
3. æ•°æ®è·¯å¾„æ˜¯å¦æ­£ç¡®é…ç½®
4. æ—¥å¿—æ–‡ä»¶ä¸­çš„é”™è¯¯ä¿¡æ¯
5. å‚è€ƒä¸Šè¿° Known Issues & Fixes ç« èŠ‚

---

## ğŸ“ ç‰ˆæœ¬å†å²

### v2.1 (2025-09-08)
- âœ¨ **æ–°å¢æ–­ç‚¹ç»­è·‘åŠŸèƒ½**: æ”¯æŒä»ä¸­æ–­ç‚¹æ¢å¤åˆ†æ
- ğŸ›¡ï¸ **å†…å­˜ä¿æŠ¤æœºåˆ¶**: è‡ªåŠ¨æ¸…ç†ç¼“å­˜ï¼Œé˜²æ­¢å†…å­˜æº¢å‡º
- ğŸ“Š **æ»šåŠ¨æ—¥å¿—ç³»ç»Ÿ**: é˜²æ­¢å•ä¸ªæ—¥å¿—æ–‡ä»¶è¿‡å¤§
- ğŸš€ **ä¸€é”®å¯åŠ¨è„šæœ¬**: æ”¯æŒåå°è¿è¡Œï¼Œæ–¹ä¾¿ç®¡ç†
- ğŸ”§ **æ—¶åŒºå¤„ç†ä¼˜åŒ–**: å®Œå–„Unixæ—¶é—´æˆ³è½¬æ¢é€»è¾‘
- ğŸ“ˆ **å†’çƒŸæµ‹è¯•è„šæœ¬**: å¿«é€ŸéªŒè¯ç³»ç»ŸåŠŸèƒ½
- ğŸ“‹ **ç›‘æ§å’Œåœæ­¢**: å®Œæ•´çš„ç”Ÿäº§ç¯å¢ƒç®¡ç†å·¥å…·

### v2.0 (2025-09-07)
- ğŸ¯ **æ ¸å¿ƒåˆ†æåŠŸèƒ½**: 53åªæ¸¯è‚¡å…¨æ—¶é—´æ¡†æ¶æŠ€æœ¯å› å­åˆ†æ
- ğŸ“Š **å¤šå› å­éªŒè¯**: RSIã€MACDã€Momentumç­‰æŠ€æœ¯æŒ‡æ ‡
- ğŸŒ **æ—¶åŒºç»Ÿä¸€å¤„ç†**: è‡ªåŠ¨å¤„ç†Unixæ—¶é—´æˆ³è½¬æ¢
- ğŸ’° **çœŸå®äº¤æ˜“æˆæœ¬**: æ¸¯è‚¡å®é™…äº¤æ˜“æˆæœ¬è®¡ç®—

---

**ç‰ˆæœ¬**ï¼šv2.1  
**æœ€åæ›´æ–°**ï¼š2025-09-08  
**ç»´æŠ¤çŠ¶æ€**ï¼šæ´»è·ƒå¼€å‘ä¸­  
**ä¸‹æ¬¡æ›´æ–°**: è®¡åˆ’æ·»åŠ æ›´å¤šæŠ€æœ¯å› å­å’Œæœºå™¨å­¦ä¹ ç‰¹å¾