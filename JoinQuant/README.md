# 策略名称

增强版动态持仓管理策略 v8.2 (因子化/最终修复版)

## 策略概述

本策略是一个综合性的A股量化交易策略，旨在通过结合技术指标和基本面因子，实现稳健的股票筛选和动态的风险管理。策略的核心是利用JQData和JQFactor库进行高效的数据获取和因子计算，筛选出具有上涨潜力的股票，并利用基于ATR（平均真实波幅）的动态止损和趋势线进行持仓管理。

## 核心特点

- **因子化选股**: 高效利用 `JQFactor` 库，一体化完成数据获取、筛选和评分，减少代码复杂度和运行时间。
- **多因子模型**: 综合运用RSI、CCI、布林带等技术指标以及PE市盈率、换手率、流通市值等基本面数据。
- **动态风险管理**:
    - **趋势止损**: 当股价跌破10日移动平均线时卖出，规避下跌趋势。
    - **ATR动态追踪止损**: 根据入场后的最高价和ATR值动态计算止损线，保护利润，避免过早止损。
- **交易冷却机制**: 股票卖出后，会进入一个为期5天的“冷却期”，在此期间不会再次买入，以避免在震荡行情中反复交易。
- **交易日过滤**: 策略设定每周二和周五不执行任何买入操作，以规避特定交易日的市场波动风险。

## 策略工作流程

1.  **初始化 (`initialize`)**
    - 设置聚宽平台的回测参数，如使用真实价格、设置基准（沪深300）等。
    - 定义策略的核心参数，如每日最大买入数量、ATR止损乘数、卖出后冷却天数。
    - 调度每日在特定时间运行的函数。

2.  **盘前准备 (`before_trading_start` @ 08:45)**
    - 每个交易日开盘前，重置当日的选股列表、已买入/卖出股票记录。
    - 更新冷却期股票列表，移除已到期的股票。

3.  **选股与排名 (`filter_and_rank_stocks` @ 09:00)**
    - 获取全A股列表，并进行基础过滤（剔除科创板、北交所、上市不足60天和ST股票）。
    - 使用 `get_factor_values` 批量获取所需因子的数据。
    - **初步筛选**: 保留流通市值大于20亿、RSI在30-75之间、CCI在-150-150之间、换手率大于1%的股票。
    - **综合评分**:
        - 计算股价在布林带中的相对位置 (`boll_position`)。
        - 计算PE市盈率的百分位排名 (`pe_score`)。
        - 最终得分 = 60% * 布林带位置 + 40% * (1 - PE排名)，即倾向于选择布林带位置高且PE估值低的股票。
    - 选取综合评分最高的20只股票作为当日的备选股池。

4.  **执行买入 (`execute_buys` @ 09:31)**
    - 检查是否为周二或周五，若是则跳过买入。
    - 从备选股池中，选取未持仓且不在冷却期的股票，按排名买入，每日最多买入5只。
    - 每只股票的买入金额为总资产的10%和20万元中的较小值。

5.  **持仓管理 (`handle_data` - 每分钟运行)**
    - 遍历当前所有持仓。
    - **更新最高价**: 实时跟踪并更新每只持仓股自买入以来的最高价。
    - **检查止损条件**:
        - **趋势止损**: 如果当前价格低于10日均线，立即卖出。
        - **ATR追踪止损**: 止损线 = 持仓期间最高价 - 3 * 14日ATR。如果当前价格低于此止损线，立即卖出。
    - 触发卖出后，将该股票加入冷却列表。

6.  **每日总结 (`daily_summary` @ 15:01)**
    - 收盘后，打印当日的买入和卖出操作总结。

## 依赖库

- `jqdata`
- `jqfactor`
- `pandas`
- `numpy`
- `talib` (用于计算ATR)

---

## 如何使用

1.  **登录聚宽平台**: 打开 [JoinQuant官网](https://www.joinquant.com/) 并登录您的账户。
2.  **创建策略**: 进入“策略研究”->“我的策略”，点击“新建策略”。
3.  **复制代码**: 将 `0819-2.py` 文件中的全部代码复制并粘贴到聚宽平台的策略编辑器中。
4.  **配置回测**:
    - 在页面右侧的“回测设置”中，选择您希望的回测时间段。
    - 设置初始资金，例如1,000,000元。
    - 频率选择“分钟级”。
5.  **运行回测**: 点击“编译运行”，然后点击“开始回测”。
6.  **分析结果**: 回测结束后，您可以在下方查看详细的收益曲线、交易详情和风险指标。

## 参数调整

您可以在 `initialize` 函数中调整以下核心参数以进行策略优化：

- `g.daily_buy_count = 5`
  - **说明**: 每日最多买入的股票数量。增加此值会提高持仓分散度，但可能买入评分较低的股票；减少此值则更集中于评分最高的几只股票。
- `g.atr_stop_multiplier = 3.0`
  - **说明**: ATR追踪止损的乘数。这是一个关键的风险控制参数。较小的值（如2.0-2.5）会使止损更敏感，更快地卖出；较大的值（如3.5-4.0）则能容忍更大的价格回撤，可能捕捉到更长的趋势，但也会承担更大的风险。
- `g.cooldown_days = 5`
  - **说明**: 股票卖出后的冷却天数。此设置用于防止在短期震荡中对同一只股票进行反复的买卖。可以根据市场波动性进行调整，市场波动大时可适当延长。

## 免责声明

本策略仅为量化交易研究和学习之用，不构成任何投资建议。策略中使用的历史数据回测结果并不代表未来实际收益。股市有风险，投资需谨慎。在进行任何实际交易前，请务必进行充分的研究和风险评估。策略作者不对使用本策略所导致的任何亏损负责。